<!doctype html>
<html>
  <head>
    <title>OAuth Callback Handler</title>
  </head>
  <body>
    <script>
      const clientId = "Jtx8pKWLU54C7IMfz8xmAxt7tG4Ourj0jHM5KIDUrXg";
      const clientSecret = "Q4A525OFRsYM4ryOapQ-Oth65139lcshVg-q0vBRSWw";
      const redirectUri = encodeURIComponent("https://yppo.websitetotal.com/callback/");
      const tokenUri = "https://yppousers.websitetotal.com/marko_auth.json";

      function handleAuthCallback() {
        const queryString = window.location.search;
        const urlParams = new URLSearchParams(queryString);
        const code = urlParams.get("code");

        if (code) {
          exchangeCodeForToken(code);
        } else {
          console.error("Error: Authorization code not received.");
        }
      }

      function exchangeCodeForToken(code:any) {
        const body = `grant_type=authorization_code&code=${code}&redirect_uri=${redirectUri}&client_id=${clientId}&client_secret=${clientSecret}`;

        fetch(tokenUri, {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
          },
          body: body,
        })
          .then((response) => response.json())
          .then((data) => {
            localStorage.setItem('yppo_user_auth', data.access_token);
            window.history.go(-2);
          })
          .catch((error) => {
            console.error("Error exchanging token:", error);
          });
      }

      if (window.location.search.includes("code=")) {
        handleAuthCallback();
      }
    </script>
  </body>
</html>
