---
import { i18nConfig } from "@/i18n/i18nConfig"
import getCoursesCategories from "@/lib/utils/getCoursesCategories"

import CategoryTemplate from "@/templates/pages/CategoryTemplate.astro"

import { slugify } from "@/lib/utils/textConverter"
import { sanityFetch } from "@/lib/utils/sanityFetch"

export async function getStaticPaths() {
  const paths: any = []
  const { defaultLocale, locales } = i18nConfig

  const posts = await sanityFetch({ type: "course", query: `language != '${defaultLocale}'`, pipe: "order(_createdAt desc)" })
  const allCategories = getCoursesCategories(posts)

  locales?.map((currentLocale: string) => {
    if (currentLocale !== defaultLocale) {
      allCategories?.map((categoryItem: any) => {
        const categorySlug = slugify(Object.keys(categoryItem)?.[0])

        paths.push({
          params: {
            lang: currentLocale,
            category: categorySlug
          },
          props: { category: Object.values(categoryItem)[0], allCategories, allPosts: posts }
        })
      })
    }
  })

  return paths
}

const { lang } = Astro.params
const { category, allCategories, allPosts } = Astro.props
---

<CategoryTemplate category={category} allCategories={allCategories} allPosts={allPosts} lang={lang} />
