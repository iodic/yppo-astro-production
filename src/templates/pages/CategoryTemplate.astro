---
import { sanityFetch } from "@/lib/utils/sanityFetch"

import Base from "@/layouts/Base.astro"
import BlogCategories from "@/components/blog/BlogCategories.astro"
import Blogs from "@/components/Blogs.astro"
import PageHeader from "@/components/PageHeader.astro"
import Shape from "@/components/Shape.astro"

import { humanize } from "@/lib/utils/textConverter"

const { category, lang } = Astro.props

const categoriesPageData = await sanityFetch({
  type: "categoriesPage",
  lang,
  object: `{
      title,
      pageMetadata {
        ...,
        "metaImage": metaImage.asset->url,
      },
      heroSection,
      generalText,
  }`
})

const { title, pageMetadata, heroSection, generalText } = categoriesPageData[0] || {}
const { metaTitle, metaDescription, metaImage, noIndex, canonicalUrl } = pageMetadata || {}

const allPosts = await sanityFetch({ type: "course", lang, pipe: "order(_createdAt desc)" })
let postTagsArrays = allPosts.map((post: any) => post.tags)
let allCategories: string[] = []
postTagsArrays.map((tagArray: any[]) => {
  tagArray.map(tag => {
    if (allCategories.indexOf(tag) === -1) {
      allCategories.push(tag)
    }
  })
})

const posts = await sanityFetch({ type: "course", lang, query: `'${category}' in tags[]`, pipe: "order(_createdAt desc)" })
---

<Base
  title={title && title}
  meta_title={metaTitle && metaTitle}
  description={metaDescription && metaDescription}
  image={metaImage && metaImage}
  noindex={noIndex && noIndex}
  canonical={canonicalUrl && canonicalUrl}
>
  <Shape />

  <section class="page-hero pb-8 pt-16">
    <div class="container">
      <div class="page-hero-content mx-auto max-w-[883px] text-center">
        <PageHeader pageData={{ title, heroSection }} />
        {
          generalText?.categoryText && (
            <h1 class="h2 mb-14 text-center">
              {generalText?.categoryText} <br /> <span class="text-primary">{humanize(category)}</span>
            </h1>
          )
        }
      </div>
    </div>
  </section>

  <section class="section">
    <div class="container">
      <BlogCategories categories={allCategories} />
      <Blogs posts={posts} />
    </div>
  </section>
</Base>
